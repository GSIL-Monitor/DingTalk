/**
  * windmill.rax.min.js v0.3.2.
  */
console.log("Start windmill rax.min (0.3.2) framework. Build at 2018-07-20 12:23"),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["windmill-rax"]=t()}(this,function(){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{writable:!0,enumerable:!1,configurable:!0,value:function(e,t){var n=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var a=Object(e),i=1;i<arguments.length;i++){var r=n[i];if(null!=r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(a[o]=r[o])}return a}});var t,n,o=(t=1e5,function(){var e=String(t);return t+=1,e});function d(){return"undefined"!=typeof global?global:"undefined"!=typeof self?self:new Function("return this")()}function i(){if(!n){var e=d();e.__windmill_environment__?n=e.__windmill_environment__:console.error("[error][wml-w] missing __windmill_environment__")}return n||{}}function r(t,n,e){void 0===e&&(e=!0);var a=d();try{Object.defineProperty(a,t,{value:n,configurable:!0,enumerable:!0,writable:!e})}catch(e){a[t]=n}}function s(e){return"Object"===(t=e,Object.prototype.toString.call(t).slice(8,-1));var t}function c(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t]}var a=function(){},l={};function p(e,t){if("object"==typeof process&&process&&process.env,!0===l.debugMode)return!0}function u(e,t){p()&&a("debug",e)}function f(e,t){p()&&a("warn",e)}function g(e,t){p()&&a("error",e)}function v(e){g(e)}a=function(e,t){var n,a="["+((n=e).charAt(0).toUpperCase()+n.slice(1))+"][wml-w] "+t;console.log(a)};var h={miniApp:["setAppShareInfo","hideLauncherLoading"],network:["request"],mtop:["request"],storage:["length","setItem","getItem","removeItem"],memoryStorage:["setItem","getItem"],navigator:["push","pop","openMessagePage","reloadPage","getBackStack","popToHome"],user:["login","logout","info"],modal:["alert","confirm","toast"],navigatorBar:["show","hide","setTitle","setRightItem","setStyle","setDrawer","setActionSheet","hasIndexBadge","scaleIndexBadge","resetIndexBadge","getHeight","openDrawer","isDrawerOpened","closeDrawer","setLeftItem","showMenu","hideMenu","getStatusBarHeight"],clipboard:["writeText","readText"],picker:["pick","pickDate","pickTime","chooseCity"],webSocket:["webSocket","send","close","onOpen","onMessage","onClose","onError"],calendar:["addEvent","checkEvent","removeEvent"],connection:["getType","getDownlinkMax","onChange"],screen:["setAlwaysOn","setBrightness"],broadcast:["createChannel","postMessage","onMessage","close"],share:["doShare"],cookie:["read","write","getAllObjects"],audio:["load","play","pause","stop","setVolume","canPlayType"],wopc:["authLogin","checkAuthSession","doAuth","getSessionKey","setSessionKey"],WopcMtopPlugin:["request"],device:["onShake","vibrate"],keyboard:["hideKeyboard"],contact:["choosePhoneContact"],location:["getLocation"],alipay:["tradePay"],userTrack:["commit","commitut","commitEvent","customAdvance","pageAppear","pageDisappear","skipPage","updatePageUtparam","updateNextPageUtparam"],"nuvajs-exec":["exec"]};var e=function(){};e.prototype.$on=function(e,t){return void 0===t&&(t=c),u('$on "'+e+'"'),!e&&v("invalid event name "+e+" for windmill.$on."),t===c&&v("bind event "+e+" with no callback through windmill.$on."),this.bridge.onReceiveMessage({data:{type:e},origin:this.label,type:"Event"},t)},e.prototype.$once=function(e,t){return void 0===t&&(t=c),u('$once "'+e+'"'),!e&&v("invalid event name "+e+" for windmill.$once."),t===c&&v("bind event "+e+" with no callback through windmill.$once."),this.bridge.onReceiveMessage({data:{type:e,once:!0},origin:this.label,type:"Event"},t)},e.prototype.$off=function(e,t){return u('$off "'+e+'"'),!e&&v("invalid event name "+e+" for windmill.$off."),this.bridge.unbindEventListener("Event."+e,t)},e.prototype.$cycle=function(e,t){return void 0===t&&(t=c),u('$cycle "'+e+'"'),e&&/^app:|^page(:|@)/.test(e)||v("invalid lifecycle name "+e+" for windmill.$cycle."),t===c&&v("hook lifecycle "+e+" with no callback function through windmill.$cycle."),"AppWorker"!==this.label&&/^app:/.test(e)&&v("Shouldn't bind lifecycle hook for app in a page client."),this.bridge.onReceiveMessage({type:"Lifecycle",origin:this.label,data:{type:e}},t)},e.prototype.$decycle=function(e,t){return u('$decycle "'+e+'"'),e&&/^app:|^page(:|@)/.test(e)||v("invalid lifecycle name "+e+" for windmill.$decycle."),this.bridge.unbindEventListener("Lifecycle."+e,t)},e.prototype.$emit=function(e,t,n){return void 0===t&&(t={}),u('$emit("'+e+'")'),!e&&v("invalid event name "+e+" for windmill.$emit."),n&&n!==this.label?this.bridge.postMessage({data:{type:e,data:t},origin:this.label,target:n,type:"Event"}):this.bridge.emitEvent(""+e,t)},e.prototype.$callAsync=function(n,a){var i=this;return void 0===a&&(a={}),u('$callAsync "'+n+'"'),n||v("invalid method name "+n+" for windmill.$callAsync."),new Promise(function(e,t){i.bridge.dispatchMessage({type:"ModuleCall",origin:i.label,target:"AppWorker",data:{method:n,params:a}},e,t,!1)})},e.prototype.$call=function(e,t,n,a){return void 0===t&&(t={}),void 0===n&&(n=c),void 0===a&&(a=c),u('$call "'+e+'", params: '+JSON.stringify(t)),e||v("invalid method name "+e+" for windmill.$call."),this.bridge.dispatchMessage({type:"ModuleCall",origin:this.label,target:"AppWorker",data:{method:e,params:t}},n,a,!0)},e.prototype.$registerModules=function(e){!function(a,i){if(void 0===i&&(i=!1),s(a)){var e=function(t){var e=a[t];h[t]?i||f('The "'+t+'" module has already been registered.It would be overridden.'):h[t]=[];var n=h[t];Array.isArray(e)?e.forEach(function(e){-1===n.indexOf(e)?n.push(e):i||f('The "'+e+'" of the "'+t+'" module has already been registered.')}):g('Invalid parameter type! The method list of the "'+t+'" module should be an Array.')};for(var t in a)e(t)}else g("Invalid parameter type! The module definition is not a plain object.")}(e,!0)},e.prototype.$getAvailableModules=function(){return function(e){var t={};try{t=JSON.parse(JSON.stringify(e))}catch(e){}return t}(h)};var y="[[EVENT_MAP]]";function m(e,t){var n=e[y];return Array.isArray(n[t])||(n[t]=[]),n[t]}var b=function(){u("Create new EventEmitter."),Object.defineProperty(this,y,{configurable:!1,enumerable:!1,writable:!1,value:{}})};b.prototype.on=function(e,t){return u('EventEmitter: on("'+e+'")'),m(this,e).push({listener:t,once:!1,callCount:0}),this},b.prototype.once=function(e,t){return u('EventEmitter: once("'+e+'")'),m(this,e).push({listener:t,once:!0,callCount:0}),this},b.prototype.off=function(e,t){u('EventEmitter: off("'+e+'"'+(t?", listener":"")+")");var n=this[y];if(t){var a=n[e];if(Array.isArray(a)){var i=a.findIndex(function(e){return e.listener===t});-1!==i&&a.splice(i,1)}}else delete n[e];return this},b.prototype.emit=function(t){for(var n=[],e=arguments.length-1;0<e--;)n[e]=arguments[e+1];u('EventEmitter: emit("'+t+'", '+JSON.stringify(n)+")");var a=this[y],i=a[t];return Array.isArray(i)&&(a[t]=i.filter(function(e){try{e.listener.apply(null,n),e.callCount+=1}catch(e){return g('Failed to emit "'+t+'" event.'),g(e.toString()),!0}return!e.once})),this};var _=function(e){var t,n,a=this;this._env=i(),u("Create a new WorkerBridge. ("+JSON.stringify(this._env)+")"),this._emitter=new b,this._contextEmitter=new b,this._appContext=(t=this._contextEmitter,n=t,{addEventListener:function(e,t){u("Call addEventListener in app context: "+e),"function"==typeof t?n.on(e,t):g("invalid callback argument for addEventListener: "+t)},removeEventListener:function(e,t){u("Call removeEventListener in app context: "+e),t&&"function"!=typeof t?g("invalid callback argument for addEventListener: "+t):n.off(e,t)}}),r("__receive_message__",function(e,t){u("Receive message from container. (clientId: "+e+", data: "+JSON.stringify(t)+")"),a._handleMessageFromContainer(e,t)}),r("onmessage",function(e){u("Receive message from renderer. (message: "+JSON.stringify(e)+")"),a._handleMessageFromRenderer(e)})};_.prototype.dispatchMessage=function(e,t,n,a){e.target="Container",u("Dispatch message to container. (message: "+JSON.stringify(e)+")");var i=d();if("function"!=typeof i.__dispatch_message__){var r='Can\'t find the "__dispatch_message__" API on the current context.';return g(r),n({status:"JS_ERROR",error:r})}var o=e.origin,s=e.data,c=e.callbackId,l=function(e){return e.status&&"SUCCESS"===e.status?t(e):n(e)};if("iOS"===this._env.platform)try{i.__dispatch_message__(o,s,l)}catch(e){var p=e&&(e.message||e.toString())||"call __dispatch_message__ failed.";g(p),n({status:"JS_ERROR",error:p})}else i.__dispatch_message__(o,s,this._genCallbackId(l,{origin:o,keepAlive:a,callbackId:c}))},_.prototype._genCallbackId=function(e,t){var n=t.origin,a=t.keepAlive,i=t.callbackId,r=i||o();return this._emitter[a?"on":"once"]("callback@"+n+":"+r,e),r},_.prototype.onReceiveMessage=function(e,t){var n=e.type,a=e.data;void 0===a&&(a={});var i=a.once?"once":"on";this._emitter[i](n+"."+a.type,t)},_.prototype.unbindEventListener=function(e,t){this._emitter.off(e,t)},_.prototype.emitEvent=function(e,t){void 0===t&&(t={}),this._emitter.emit("Event."+e,{type:e,data:t})},_.prototype.postMessage=function(e){u("Post message to renderer. (message: "+JSON.stringify(e)+")");var t=d();if("function"!=typeof t.postMessage)return v("global postMessage API dosn't exist!");t.postMessage(e)},_.prototype.getAppContext=function(){return u("generate app context: {"+Object.keys(this._appContext).join(", ")+"}"),this._appContext},_.prototype._handleMessageFromContainer=function(e,t){var n=t.action,a=t.callbackId,i=t.result;switch(n){case"CALLBACK":this._emitter.emit("callback@"+e+":"+a,i);break;case"LIFECYCLE":var r=i.lifecycle,o=r.match(/^page:(\S+)$/);"AppWorker"!==e&&(o&&o[1]?r="page@"+e+":"+o[1]:r.match(/^page@/)&&v("invalid lifecycle name in __receive_message__: "+r+". Shouldn't include '@clientId' in it."),this.postMessage({type:"Lifecycle",origin:this._origin,target:e,data:i})),this._emitter.emit("Lifecycle."+r,i.options);break;case"EVENT":var s,c;"Global"===e?(s=this._contextEmitter,c=i.type):(s=this._emitter,c="Event."+i.type),s&&s.emit(c,i);break;default:v("invalid action type in __receive_message__: "+n)}},_.prototype._handleMessageFromRenderer=function(t){var n=this,e=t.type,a=t.data,i=t.origin,r=t.callbackId,o=t.keepAlive;i&&"AppWorker"!==i||v('Received a message from renderer with invalid "origin": '+i+". Should be a clientId.");var s=function(e){n.postMessage({origin:n._origin,target:i,type:"Callback",callbackId:r,data:e})};switch(e){case"ModuleCall":this.dispatchMessage(t,function(e){s(e)},function(e){g("Call native module failed! "+JSON.stringify(t.data)),g(JSON.stringify(e)),s(e)},o);break;case"Event":this._emitter.emit(e+"."+a.type,Object.assign({origin:i},a));break;default:v("unexpected message type posted from renderer: "+e+".")}};var k=function(i){function e(e){var t=this;i.call(this),u("Create a new WorkerRuntime. "+JSON.stringify(e)),this._activeRenderers=[],this.label="AppWorker",this.bridge=new _({origin:this.label});var n=e.name,a=e.getContext;r("__get_app_context__",function(){var e=a();return u("Get app running context ("+n+"). "+Object.keys(e)),Object.assign(t.bridge.getAppContext(),e)}),this._ready()}return i&&(e.__proto__=i),((e.prototype=Object.create(i&&i.prototype)).constructor=e).prototype._ready=function(){var n=this;this.bridge.onReceiveMessage({origin:this.label,type:"Event",data:{type:"registerModules"}},function(t){t&&"registerModules"===t.type&&(u("Register available modules: ("+JSON.stringify(t.data)+")"),n.$registerModules(t.data),n._activeRenderers.forEach(function(e){n.bridge.postMessage({origin:n.label,target:e.label,type:"Event",data:t})}))}),this.bridge.onReceiveMessage({origin:this.label,type:"Event",data:{type:"[[RendererRuntimeReady]]"}},function(e){if(e&&s(e.data)){u("Receive renderer ready message. ("+JSON.stringify(e.data)+")"),n._activeRenderers.push(e.data);var t=e.data.label;n.bridge.postMessage({origin:n.label,target:t,type:"Event",data:{type:"registerModules",data:n.$getAvailableModules()}})}}),this.bridge.dispatchMessage({origin:"AppWorker",type:"ModuleCall",data:{method:"AppWorker.ready"}},function(){var e;e='Dispatched "AppWorker.ready" event success.',p()&&a("log",e)},function(){v('Failed to dispatch "AppWorker.ready" event.')})},e}(e),w=["$on","$once","$off","$emit","$cycle","$decycle","$call","$callAsync","$navTo","$getAvailableModules"];function E(e){!function(e){if(!e||!e.platform)return console.error("set logger environment failed.");Object.assign(l,e)}(i()),u("Setup Windmill worker framework.");var a,t,n=new k(e);return u("Prepare runtime APIs: "+JSON.stringify(w)),a=n,t={},w.forEach(function(n){"function"==typeof a[n]&&(t[n]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return a[n].apply(a,e)})}),t}function $(e){var a={global:{}};return{initGlobalData:function(e){a.global=e},setGlobalData:function(e,t){a.global[e]=t},getGlobalData:function(e){return a.global[e]},initData:function(e,t){a["page"+e]=t},setData:function(e,t,n){a["page"+e][t]=n},getData:function(e,t){return a["page"+e][t]}}}function A(n){return{postMessage:function(e,t){n.$emit("message",e,t)},addEventListener:function(e,t){n.$on("message",t)}}}var M={},S=null;function C(e){return M[e]}function O(e){u("Create a page instance ("+JSON.stringify(e)+").");var t,n,a=e.data,i=a.pageName,r=a.clientId;n=r,M[t=i]?M[t].clientId=n:M[t]={clientId:n};var o=C(i);if(S&&o){o.config;var s=M[i].lifecycles;if(s&&s.length)for(var c=function(e){var n=s[e].hookName,a=s[e].callback;"function"==typeof a&&(u('Listening the "'+n+'" lifecycle of page ('+r+")."),S.$cycle("page@"+r+":"+n,function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];u('Emit the "'+n+'" lifecycle of page ('+r+")."),a.apply(void 0,e)}))},l=0;l<s.length;l++)c(l)}}var x=null;function I(){return x}function R(r,e,t){u("Define a new page "+r+".");var n,a,i,o=$(),s=A(t);return a=e,i=t,M[n=r]?g("The page "+n+" has already been registered!"):(u('Register page: "'+n+'".'),M[n]={name:n,config:a},S=i),e.data&&o.initData(r,e.data||{}),{on:function(e,t){var n,a,i;a=e,i=t,M[n=r].lifecycles||(M[n].lifecycles=[]),M[n].lifecycles.push({hookName:a,callback:i})},postMessage:function(e){var t=C(r);if(t){var n=t.clientId;s.postMessage(e,n)}},setData:function(e,t){o.setData(r,e,t)},getData:function(e){o.getData(r,e)}}}var D=h;function L(){u("Setup Rax framework in worker.");var e=i();e&&(e.frameworkType="Rax",e.frameworkVersion="0.3.2");var s=E({name:"Rax",getContext:function(){var r=function(e){return function(e,t){if(x)return g("The app instance has already been created!"),x;u("Create App instance.");var n=$(),a=A(t);t.$on("error",function(){e.onError&&e.onError()}),t.$on("pageNotFound",function(){e.onPageNotFound&&e.onPageNotFound()}),t.$on("beforePageCreate",function(e){u("Before Page Create "+JSON.stringify(e)),O(e)}),e.globalData&&n.initGlobalData(e.globalData);var i={on:function(n,a){"function"==typeof a&&(u('Listening the "'+n+'" lifecycle of app.'),t.$cycle("app:"+n,function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];u('Emit the "'+n+'" lifecycle of app.'),a.apply(void 0,e)}))},addEventListener:function(e,t){a.addEventListener(e,t)},setGlobalData:n.setGlobalData,getGlobalData:n.getGlobalData};return x=i}(e,s)},o=function(e,t){return R(e,t,s)};return{require:function(e){var n={app:r,page:o},t=function(i){n[i]={};for(var e=function(e){var a=D[i][e];n[i][a]=function(e,t,n){s.$call(i+"."+a,e,t,n)}},t=0;t<D[i].length;t++)e(t)};for(var a in D)t(a);var i=e.split("@core/")[1];return n[i]},getApp:I}}})}return L(),L});